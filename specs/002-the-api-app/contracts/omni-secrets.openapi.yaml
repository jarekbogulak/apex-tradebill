openapi: 3.1.0
info:
  title: Apex Omni Secret Management API
  version: 0.1.0
  description: |
    Internal endpoints that orchestrate Google Secret Manager usage for Apex Omni credentials.
    All routes require operator or service authentication with scoped IAM roles.
servers:
  - url: https://api.apex-tradebill.com
    description: Production
  - url: https://staging-api.apex-tradebill.com
    description: Staging (non-sensitive test credentials only)
components:
  securitySchemes:
    serviceAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    SecretType:
      type: string
      enum: [trading_api_key, trading_client_secret, webhook_shared_secret]
    SecretStatus:
      type: string
      enum: [active, rotating, deprecated]
    SecretMetadata:
      type: object
      required: [secretType, status, gcpSecretId, lastRotatedAt, rotationDueAt, cacheSource]
      properties:
        secretType:
          $ref: '#/components/schemas/SecretType'
        status:
          $ref: '#/components/schemas/SecretStatus'
        gcpSecretId:
          type: string
        gcpVersionAlias:
          type: string
        lastRotatedAt:
          type: string
          format: date-time
        rotationDueAt:
          type: string
          format: date-time
        lastValidatedAt:
          type: string
          format: date-time
          nullable: true
        cacheSource:
          type: string
          enum: [gsm, break_glass, empty]
        cacheAgeSeconds:
          type: integer
          minimum: 0
        breakGlassExpiresAt:
          type: string
          format: date-time
          nullable: true
paths:
  /ops/apex-omni/secrets/status:
    get:
      summary: List Apex Omni secret metadata and cache freshness
      security:
        - serviceAuth: []
      responses:
        '200':
          description: Current metadata for all production-only Apex Omni secrets
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/SecretMetadata'
                  updatedAt:
                    type: string
                    format: date-time
        '403':
          description: Caller lacks operator scope
  /ops/apex-omni/secrets/rotation-preview:
    post:
      summary: Validate a new Google Secret Manager version without promoting it
      security:
        - serviceAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [secretType, gcpSecretVersion]
              properties:
                secretType:
                  $ref: '#/components/schemas/SecretType'
                gcpSecretVersion:
                  type: string
                dryRunWebhookUrl:
                  type: string
                  format: uri
                  description: Optional override for webhook validation target
      responses:
        '200':
          description: Validation attempt results
          content:
            application/json:
              schema:
                type: object
                required: [validated, latencyMs]
                properties:
                  validated:
                    type: boolean
                  latencyMs:
                    type: integer
                  errorCode:
                    type: string
                    nullable: true
                  message:
                    type: string
        '409':
          description: Secret already validated or conflicting rotation in progress
  /internal/apex-omni/secrets/cache/refresh:
    post:
      summary: Force the API process to evict cached secrets and fetch from GSM
      security:
        - serviceAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                secretType:
                  $ref: '#/components/schemas/SecretType'
                  description: Refresh a specific secret; refreshes all when omitted
      responses:
        '202':
          description: Refresh scheduled
          content:
            application/json:
              schema:
                type: object
                properties:
                  requestId:
                    type: string
                  refreshedSecretTypes:
                    type: array
                    items:
                      $ref: '#/components/schemas/SecretType'
  /ops/apex-omni/secrets/break-glass:
    post:
      summary: Supply a manual fallback secret when GSM is unavailable
      security:
        - serviceAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [secretType, ciphertext, expiresAt]
              properties:
                secretType:
                  $ref: '#/components/schemas/SecretType'
                ciphertext:
                  type: string
                  description: Encrypted payload produced by the CLI using the API's public key
                expiresAt:
                  type: string
                  format: date-time
      responses:
        '201':
          description: Break-glass secret accepted and scheduled to expire automatically
          content:
            application/json:
              schema:
                type: object
                properties:
                  secretType:
                    $ref: '#/components/schemas/SecretType'
                  expiresAt:
                    type: string
                    format: date-time
        '422':
          description: Payload failed validation or TTL exceeds 30 minutes
